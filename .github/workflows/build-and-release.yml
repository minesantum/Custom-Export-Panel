name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Download OBS Studio Source
      run: |
        Write-Host "Downloading OBS Studio source code..."
        $obsVersion = "32.0.4"
        $url = "https://github.com/obsproject/obs-studio/archive/refs/tags/${obsVersion}.zip"
        
        Invoke-WebRequest -Uri $url -OutFile "obs-source.zip"
        Expand-Archive -Path "obs-source.zip" -DestinationPath "." -Force
        
        $obsSourceDir = "obs-studio-${obsVersion}"
        echo "OBS_SOURCE_DIR=$PWD\$obsSourceDir" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Download OBS Dependencies
      run: |
        Write-Host "Downloading OBS dependencies..."
        $depsVersion = "2025-08-23"
        
        $qtUrl = "https://github.com/obsproject/obs-deps/releases/download/${depsVersion}/windows-deps-qt6-${depsVersion}-x64.zip"
        Invoke-WebRequest -Uri $qtUrl -OutFile "qt-deps.zip"
        New-Item -ItemType Directory -Force -Path "deps/qt6"
        Expand-Archive -Path "qt-deps.zip" -DestinationPath "deps/qt6" -Force
        
        $obsUrl = "https://github.com/obsproject/obs-deps/releases/download/${depsVersion}/windows-deps-${depsVersion}-x64.zip"
        Invoke-WebRequest -Uri $obsUrl -OutFile "obs-deps.zip"
        New-Item -ItemType Directory -Force -Path "deps/obs"
        Expand-Archive -Path "obs-deps.zip" -DestinationPath "deps/obs" -Force
        
        echo "QT_DEPS_DIR=$PWD\deps\qt6" >> $env:GITHUB_ENV
        echo "OBS_DEPS_DIR=$PWD\deps\obs" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Build OBS Libraries
      run: |
        Write-Host "Building OBS libraries..."
        
        cd $env:OBS_SOURCE_DIR
        
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$env:QT_DEPS_DIR;$env:OBS_DEPS_DIR" -DENABLE_BROWSER=OFF -DENABLE_WEBSOCKET=OFF -DENABLE_UI=OFF -DBUILD_FOR_DISTRIBUTION=OFF
        
        cmake --build build --config Release --target obs-frontend-api
        cmake --build build --config Release --target libobs
        
        New-Item -ItemType Directory -Force -Path "$PWD\..\libs"
        Copy-Item "build\libobs\Release\obs.lib" -Destination "$PWD\..\libs\" -Force
        Copy-Item "build\UI\obs-frontend-api\Release\obs-frontend-api.lib" -Destination "$PWD\..\libs\" -Force
        
        cd ..
      shell: pwsh
      
    - name: Configure Plugin
      run: |
        $qt6Dir = "$env:QT_DEPS_DIR\lib\cmake\Qt6"
        
        Write-Host "Configuring plugin..."
        Write-Host "Qt6_DIR: $qt6Dir"
        Write-Host "OBS_SOURCE_DIR: $env:OBS_SOURCE_DIR"
        
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DQt6_DIR="$qt6Dir" -DOBS_SOURCE_DIR="$env:OBS_SOURCE_DIR" -DCMAKE_PREFIX_PATH="$env:QT_DEPS_DIR;$env:OBS_DEPS_DIR"
      shell: pwsh
      
    - name: Build Plugin
      run: cmake --build build --config Release
      
    - name: Prepare Release Files
      run: |
        New-Item -ItemType Directory -Force -Path "release"
        Copy-Item "build\Release\custom-export-panel.dll" -Destination "release\"
        
        if (Test-Path "export_config.ini.example") {
          Copy-Item "export_config.ini.example" -Destination "release\"
        }
        
        Set-Content -Path "release\README.md" -Value "# Custom Export Panel for OBS Studio`n`n## Instalacion`n`n1. Copia custom-export-panel.dll a: C:\Program Files\obs-studio\obs-plugins\64bit\`n2. Reinicia OBS Studio`n`n## Creador`n`nPlugin creado por DonKolia"
      shell: pwsh
      
    - name: Create ZIP
      run: |
        Compress-Archive -Path "release\*" -DestinationPath "custom-export-panel-${{ github.ref_name }}.zip"
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          custom-export-panel-${{ github.ref_name }}.zip
          release/custom-export-panel.dll
        body: |
          ## Custom Export Panel v${{ github.ref_name }}
          
          Plugin de exportacion personalizada para OBS Studio.
          
          ### Instalacion
          
          1. Descarga custom-export-panel.dll
          2. Copia el archivo a C:\Program Files\obs-studio\obs-plugins\64bit\
          3. Reinicia OBS Studio
          
          ### Creador
          
          Plugin creado por **DonKolia**
          
          ### Archivos
          
          - custom-export-panel.dll - Plugin compilado
          - custom-export-panel-${{ github.ref_name }}.zip - Paquete completo con README
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
