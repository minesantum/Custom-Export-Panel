name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
      
    - name: Setup CMake and Ninja
      uses: lukka/get-cmake@latest
      
    - name: Cache OBS Studio
      id: cache-obs
      uses: actions/cache@v3
      with:
        path: obs-studio
        key: obs-studio-30.2.2-windows
        
    - name: Download and Build OBS Studio
      if: steps.cache-obs.outputs.cache-hit != 'true'
      run: |
        # Descargar c√≥digo fuente de OBS
        git clone --recursive https://github.com/obsproject/obs-studio.git
        cd obs-studio
        git checkout 30.2.2
        git submodule update --init --recursive
        
        # Descargar dependencias precompiladas
        $depsVersion = "2024-08-20"
        Invoke-WebRequest -Uri "https://github.com/obsproject/obs-deps/releases/download/$depsVersion/windows-deps-$depsVersion-x64.zip" -OutFile "windows-deps.zip"
        Invoke-WebRequest -Uri "https://github.com/obsproject/obs-deps/releases/download/$depsVersion/windows-deps-qt6-$depsVersion-x64.zip" -OutFile "windows-deps-qt6.zip"
        
        Expand-Archive -Path "windows-deps.zip" -DestinationPath "./deps" -Force
        Expand-Archive -Path "windows-deps-qt6.zip" -DestinationPath "./deps" -Force
        
        # Configurar y compilar solo las bibliotecas necesarias
        cmake -S . -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=RelWithDebInfo `
          -DCMAKE_PREFIX_PATH="$PWD/deps" `
          -DENABLE_BROWSER=OFF `
          -DENABLE_WEBSOCKET=OFF `
          -DENABLE_AJA=OFF `
          -DENABLE_PLUGINS=OFF `
          -DBUILD_TESTS=OFF
        
        cmake --build build --config RelWithDebInfo --target obs-frontend-api
        cmake --build build --config RelWithDebInfo --target libobs
        
        cd ..
      shell: pwsh
      
    - name: Configure Plugin
      run: |
        $obsDir = "$PWD/obs-studio"
        $qt6Dir = "$obsDir/deps/lib/cmake/Qt6"
        
        cmake -S . -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=RelWithDebInfo `
          -DQt6_DIR="$qt6Dir" `
          -DOBS_SOURCE_DIR="$obsDir" `
          -DCMAKE_PREFIX_PATH="$obsDir/deps"
      shell: pwsh
      
    - name: Build Plugin
      run: cmake --build build --config RelWithDebInfo
      
    - name: Prepare Release Files
      run: |
        New-Item -ItemType Directory -Force -Path "release"
        
        # Buscar el DLL en diferentes ubicaciones posibles
        $dllPaths = @(
          "build/custom-export-panel.dll",
          "build/RelWithDebInfo/custom-export-panel.dll",
          "build/Release/custom-export-panel.dll"
        )
        
        $found = $false
        foreach ($path in $dllPaths) {
          if (Test-Path $path) {
            Copy-Item $path -Destination "release/custom-export-panel.dll"
            Write-Host "Found DLL at: $path"
            $found = $true
            break
          }
        }
        
        if (-not $found) {
          Write-Error "Could not find compiled DLL"
          exit 1
        }
        
        if (Test-Path "export_config.ini.example") {
          Copy-Item "export_config.ini.example" -Destination "release/"
        }
        
        # Crear README
        $readme = "# Custom Export Panel for OBS Studio`n`n"
        $readme += "## Instalacion`n`n"
        $readme += "1. Copia custom-export-panel.dll a: C:\Program Files\obs-studio\obs-plugins\64bit\`n"
        $readme += "2. Reinicia OBS Studio`n`n"
        $readme += "## Creador`n`n"
        $readme += "Plugin creado por DonKolia`n"
        
        Set-Content -Path "release/README.txt" -Value $readme
      shell: pwsh
      
    - name: Create ZIP
      run: |
        Compress-Archive -Path "release/*" -DestinationPath "custom-export-panel-${{ github.ref_name }}.zip"
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          custom-export-panel-${{ github.ref_name }}.zip
          release/custom-export-panel.dll
        body: |
          ## Custom Export Panel ${{ github.ref_name }}
          
          Plugin de exportacion personalizada para OBS Studio.
          
          ### Instalacion
          
          1. Descarga `custom-export-panel.dll`
          2. Copia el archivo a `C:\Program Files\obs-studio\obs-plugins\64bit\`
          3. Reinicia OBS Studio
          
          ### Creador
          
          Plugin creado por **DonKolia**
          
          ### Archivos
          
          - `custom-export-panel.dll` - Plugin compilado
          - `custom-export-panel-${{ github.ref_name }}.zip` - Paquete completo
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
