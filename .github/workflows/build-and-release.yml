name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
      
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Download OBS Studio Headers and Libraries
      run: |
        # Descargar OBS Studio completo (contiene headers)
        Write-Host "Downloading OBS Studio..."
        $obsVersion = "30.2.2"
        Invoke-WebRequest -Uri "https://github.com/obsproject/obs-studio/archive/refs/tags/$obsVersion.zip" -OutFile "obs-source.zip"
        Expand-Archive -Path "obs-source.zip" -DestinationPath "." -Force
        Rename-Item "obs-studio-$obsVersion" "obs-studio"
        
        # Descargar dependencias Qt6
        Write-Host "Downloading Qt6 dependencies..."
        $depsVersion = "2024-08-08"
        Invoke-WebRequest -Uri "https://github.com/obsproject/obs-deps/releases/download/$depsVersion/windows-deps-qt6-$depsVersion-x64.zip" -OutFile "qt-deps.zip"
        New-Item -ItemType Directory -Force -Path "deps"
        Expand-Archive -Path "qt-deps.zip" -DestinationPath "deps" -Force
        
        # Crear directorio libs si no existe
        New-Item -ItemType Directory -Force -Path "libs"
        
        # Verificar que los archivos .lib existen en el repositorio
        if (Test-Path "libs/obs.lib") {
          Write-Host "Found obs.lib in repository"
        } else {
          Write-Error "obs.lib not found in libs directory"
          exit 1
        }
        
        if (Test-Path "libs/obs-frontend-api.lib") {
          Write-Host "Found obs-frontend-api.lib in repository"
        } else {
          Write-Error "obs-frontend-api.lib not found in libs directory"
          exit 1
        }
      shell: pwsh
      
    - name: Clean Build Directory
      run: |
        if (Test-Path "build") {
          Remove-Item -Path "build" -Recurse -Force
          Write-Host "Cleaned build directory"
        }
      shell: pwsh
      
    - name: Configure Plugin
      run: |
        $obsSourceDir = "$PWD/obs-studio"
        $qt6Dir = "$PWD/deps/lib/cmake/Qt6"
        
        Write-Host "OBS Source: $obsSourceDir"
        Write-Host "Qt6 Dir: $qt6Dir"
        
        cmake -S . -B build `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DQt6_DIR="$qt6Dir" `
          -DOBS_SOURCE_DIR="$obsSourceDir" `
          -DCMAKE_PREFIX_PATH="$PWD/deps"
      shell: pwsh
      
    - name: Build Plugin
      run: cmake --build build --config Release
      
    - name: Prepare Release Files
      run: |
        New-Item -ItemType Directory -Force -Path "release"
        
        # Buscar el DLL
        $dllPaths = @(
          "build/Release/custom-export-panel.dll",
          "build/custom-export-panel.dll"
        )
        
        $found = $false
        foreach ($path in $dllPaths) {
          if (Test-Path $path) {
            Copy-Item $path -Destination "release/custom-export-panel.dll"
            Write-Host "Found DLL at: $path"
            $found = $true
            break
          }
        }
        
        if (-not $found) {
          Write-Error "Could not find compiled DLL"
          Get-ChildItem -Path "build" -Recurse -Filter "*.dll" | ForEach-Object { Write-Host $_.FullName }
          exit 1
        }
        
        # Copiar archivo de configuraci√≥n de ejemplo
        if (Test-Path "export_config.ini.example") {
          Copy-Item "export_config.ini.example" -Destination "release/"
        }
        
        # Crear README
        $readme = "# Custom Export Panel for OBS Studio`n`n"
        $readme += "## Instalacion`n`n"
        $readme += "1. Copia custom-export-panel.dll a: C:\Program Files\obs-studio\obs-plugins\64bit\`n"
        $readme += "2. Reinicia OBS Studio`n`n"
        $readme += "## Creador`n`n"
        $readme += "Plugin creado por DonKolia`n"
        
        Set-Content -Path "release/README.txt" -Value $readme
      shell: pwsh
      
    - name: Create ZIP
      run: |
        Compress-Archive -Path "release/*" -DestinationPath "custom-export-panel-${{ github.ref_name }}.zip"
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          custom-export-panel-${{ github.ref_name }}.zip
          release/custom-export-panel.dll
        body: |
          ## Custom Export Panel ${{ github.ref_name }}
          
          Plugin de exportacion personalizada para OBS Studio.
          
          ### Instalacion
          
          1. Descarga `custom-export-panel.dll`
          2. Copia el archivo a `C:\Program Files\obs-studio\obs-plugins\64bit\`
          3. Reinicia OBS Studio
          
          ### Creador
          
          Plugin creado por **DonKolia**
          
          ### Archivos
          
          - `custom-export-panel.dll` - Plugin compilado
          - `custom-export-panel-${{ github.ref_name }}.zip` - Paquete completo con README
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
